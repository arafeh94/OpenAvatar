<html lang="en">
<head>
    <title>RTC Client</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 40px;
            background-color: #f0f4f8;
            color: #333;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 25px;
            width: 100%;
            max-width: 95%;
        }

        .code-container {
            background-color: #2d2d2d;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-container code {
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 16px;
        }

        .send-btn {
            background-color: #61dafb;
            color: #282c34;
            border: none;
            padding: 12px 20px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s, transform 0.2s;
        }

        .send-btn:hover {
            background-color: #4fa3d1;
            transform: scale(1.05);
        }

        .send-btn:focus {
            outline: none;
        }

        .card-header {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
    </style>

</head>
<body>
<div>
    <video id="video" autoplay playsinline controls></video>
    <audio id="audio" autoplay controls></audio>
    <div style="padding: 10px"></div>
    <div>
        <button onclick="rtc.request()" class="send-btn">Connect</button>
    </div>
</div>
<script>
    class Fetcher {
        constructor(base_url = null) {
            this.base_url = base_url;
        }

        async fetch(route, get = {}, post = null) {
            const url = new URL(`${this.base_url}/${route}`);

            Object.keys(get).forEach(key => url.searchParams.append(key, get[key]));

            const options = {
                method: post ? 'POST' : 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            };

            if (post) {
                options.body = JSON.stringify(post);
            }

            return fetch(url, options)
        }
    }

    class AvatarRTCClient extends Fetcher {
        static OPEN = 'onopen';
        static CLOSE = 'onclose';
        static MESSAGE = 'onmessage';
        static TRACK = 'ontrack';

        constructor() {
            super("http://localhost:8000");
            this.peer = new RTCPeerConnection();
            this.token = null;
            this.events = {};
            this.channel = null;
            this.peer.ondatachannel = (event) => {
                const channel = event.channel;
                channel.onopen = this.onopen.bind(this);
                channel.onclose = this.onclose.bind(this);
                channel.onmessage = this.onmessage.bind(this);
                this.channel = channel;
            }
            this.peer.ontrack = (event) => {
                this.ontrack(event)
            }

            this.video = document.getElementById("video");
            this.audio = document.getElementById("audio");
        }

        async request() {
            const response = await this.fetch('register').then(response => response.json());
            this.token = response.token;
            await this.peer.setRemoteDescription(response.sdp);
            await this.peer.setLocalDescription(await this.peer.createAnswer());
            const params = {'token': this.token, 'sdp': JSON.stringify(this.peer.localDescription)}
            const confirm = await this.fetch('confirm', params).then(response => response.json());
            return confirm.status === 'accepted';
        }

        onopen() {
            this.events[AvatarRTCClient.OPEN]?.();
        }

        onclose() {
            this.events[AvatarRTCClient.CLOSE]?.();
        }

        onmessage(event) {
            this.events[AvatarRTCClient.MESSAGE]?.(event.data);
        }

        ontrack(event) {
            this.events[AvatarRTCClient.TRACK]?.(event);
            const [stream] = event.streams;
            if (event.track.kind === 'video') {
                this.video.srcObject = stream;
            } else if (event.track.kind === 'audio') {
                this.audio.srcObject = stream;
            }
        }

        on(event, callback) {
            this.events[event] = callback;
        }

        send_message(message) {
            this.channel.send(message);
        }
    }

    rtc = new AvatarRTCClient()
    rtc.on(AvatarRTCClient.OPEN, () => {
        console.log('RTC open');
    })
    rtc.on(AvatarRTCClient.MESSAGE, (message) => {
        console.log(message);
    })
    rtc.on(AvatarRTCClient.TRACK, (event) => {
        console.log(event);
    })
</script>

<div style="padding: 10px"></div>
<div class="card">
    <div class="card-header">Small Avatar Request</div>
    <div class="code-container">
        <code>
            <!--@formatter:off-->
{"avatar":{"repeat":"hello samira how are you today", "persona":"lisa_casual_720_pl"}}
            <!--@formatter:on-->
        </code>
        <button class="send-btn" onclick="avatar_send(this)">Send</button>
    </div>
</div>

<div style="padding: 10px"></div>
<div class="card">
    <div class="card-header">Large Avatar Request</div>
    <div class="code-container">
        <code>
            <!--@formatter:off-->
{"avatar":{"repeat":"Healthcare in the United States is a complex and multifaceted system that combines public and private elements, presenting both opportunities and challenges for individuals, policymakers, and the economy. It is often described as one of the most advanced healthcare systems in the world in terms of medical technology, research, and access to specialized care. However, it is also marked by disparities in access, affordability, and outcomes, which contribute to ongoing debates about reform and improvement. The healthcare system is largely dominated by private insurance companies, with a significant portion of the population receiving coverage through employer-sponsored insurance plans. In addition to these private plans, there are public health programs like Medicaid and Medicare that provide coverage for low-income individuals and those over the age of 65, respectively. However, a substantial number of Americans remain uninsured or underinsured, which has led to concerns about the overall effectiveness and equity of the system.", "persona":"lisa_casual_720_pl"}}
            <!--@formatter:on-->
        </code>
        <button class="send-btn" onclick="avatar_send(this)">Send</button>
    </div>
</div>

<script>
    function avatar_send(button) {
        const codeText = button.previousElementSibling.textContent.trim();
        console.log(codeText);
        rtc.send_message(codeText);
        button.textContent = 'Sending...';
        setTimeout(() => {
            button.textContent = 'Send';  // Reset text to 'Send' after 2 seconds
        }, 1000);
    }
</script>


</body>
</html>